<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order & Menu Management UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f6fa; }
        .container { max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ddd; padding: 24px; }
        h1 { text-align: center; color: #333; }
        .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 24px; }
        .tab { padding: 12px 24px; cursor: pointer; border-radius: 8px 8px 0 0; margin-right: 4px; background: #f9f9f9; }
        .tab.active { background: #fff; border-bottom: 2px solid #fff; font-weight: bold; color: #1976d2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { margin-bottom: 32px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; }
        button { margin-top: 16px; padding: 10px 18px; background: #4a90e2; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #357ab8; }
        .response { background: #e9f7ef; padding: 12px; border-radius: 4px; margin-top: 10px; color: #333; font-size: 0.97em; }
        .error { background: #fbeee6; color: #d9534f; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 7px; text-align: left; }
        th { background: #e6e6e6; }
        .inline-btn { margin: 0 3px; padding: 5px 10px; font-size: 0.95em; }
        .flex-row { display: flex; gap: 10px; }
        .flex-grow { flex: 1; }
        .mt-0 { margin-top: 0; }
        .order-status { font-weight: bold; }
        .paid { color: #28a745; }
        .pending { color: #ffc107; }
        .cancelled { color: #dc3545; }
        .completed { color: #17a2b8; }
        .admin-panel { display: flex; gap: 20px; }
        .admin-orders { flex: 1; }
        .admin-actions { width: 300px; }
        
        /* Customer Order Styles */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-item { background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .menu-item h4 { margin: 0 0 10px 0; color: #333; }
        .menu-item p { margin: 5px 0; color: #666; }
        .menu-item .price { font-weight: bold; color: #2c3e50; }
        .item-qty { width: 60px; margin-right: 10px; }
        .add-to-cart { background: #2ecc71; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; }
        .add-to-cart:hover { background: #27ae60; }
        #cartItems table { width: 100%; margin-top: 15px; }
        #cartItems table th { background: #f8f9fa; }
        #cartItems table td { padding: 8px; border: 1px solid #ddd; }
        #cartTotal { font-weight: bold; color: #2c3e50; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Order & Menu Management</h1>
        <div class="tabs">
            <div class="tab active" data-tab="auth">Auth</div>
            <div class="tab" data-tab="restaurants">Restaurants</div>
            <div class="tab" data-tab="menu">Menu</div>
            <div class="tab" data-tab="categories">Categories</div>
            <div class="tab" data-tab="orders">Orders</div>
            <div class="tab" data-tab="actions">Order Actions</div>
            <div class="tab" data-tab="loyalty">Loyalty</div>
            <div class="tab" data-tab="referrals">Referrals</div>
            <div class="tab" data-tab="rewards">Rewards</div>
            <div class="tab" data-tab="otp">OTP</div>
            <div class="tab" data-tab="dashboards">Dashboards</div>
        </div>
        <!-- AUTH TAB -->
        <div class="tab-content active" id="tab-auth">
            <div class="section">
                <h3>Login</h3>
                <form id="loginForm">
                    <label>Email:</label><input type="email" id="loginEmail" required>
                    <label>Password:</label><input type="password" id="loginPassword" required>
                    <button type="submit">Login</button>
                </form>
                <div id="loginResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Signup</h3>
                <form id="signupForm">
                    <label>Name:</label><input type="text" id="signupName" required>
                    <label>Email:</label><input type="email" id="signupEmail" required>
                    <label>Password:</label><input type="password" id="signupPassword" required>
                    <label>Phone Number:</label><input type="text" id="signupNumber" required>
                    <button type="submit">Signup</button>
                </form>
                <div id="signupResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Verify Token</h3>
                <form id="verifyTokenForm">
                    <label>ID Token:</label><input type="text" id="verifyIdToken" required>
                    <button type="submit">Verify</button>
                </form>
                <div id="verifyTokenResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <!-- RESTAURANTS TAB -->
        <div class="tab-content" id="tab-restaurants">
            <div class="section">
                <h3>Register Restaurant</h3>
                <form id="registerRestaurantForm">
    <label>JWT (Main Admin):</label><input type="text" id="registerRestaurantToken" required>
    <label>Restaurant Name:</label><input type="text" id="restaurantName" required>
    <label>Restaurant ID (optional, auto if blank):</label><input type="text" id="restaurantId">
    <label>Offers (JSON array, e.g. ["10% off", "Free drink"]):</label><textarea id="restaurantOffers" rows="2" required></textarea>
    <label>Points per Rupee:</label><input type="number" step="0.01" id="pointsPerRupee" required>
    <label>Points per Spin:</label><input type="number" step="0.01" id="pointsPerSpin" value="1.0" required>
    <label>Reward Thresholds (JSON array of objects):</label><textarea id="rewardThresholds" rows="2" placeholder='[{"name": "Gold", "points": 100}]'></textarea>
    <label>Spend Thresholds (JSON array of objects):</label><textarea id="spendThresholds" rows="2" placeholder='[{"amount": 1000, "reward": "Free Dessert"}]'></textarea>
    <label>Referral Rewards (JSON object):</label><textarea id="referralRewards" rows="2" placeholder='{"referral_bonus": 50}' required></textarea>
    <label>Owner UID:</label><input type="text" id="ownerUid" required>
    <label>Admin UID:</label><input type="text" id="restaurantAdminUid" required>
    <button type="submit">Register</button>
</form>
                <div id="registerRestaurantResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Update Restaurant</h3>
                <form id="updateRestaurantForm">
                    <label>JWT (Admin):</label><input type="text" id="updateRestaurantToken" required>
                    <label>Restaurant ID:</label><input type="text" id="updateRestaurantId" required>
                    <label>Restaurant Name:</label><input type="text" id="updateRestaurantName" required>
                    <label>Admin UID:</label><input type="text" id="updateRestaurantAdminUid" required>
                    <button type="submit">Update</button>
                </form>
                <div id="updateRestaurantResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Get Restaurant</h3>
                <form id="getRestaurantForm">
                    <label>Restaurant ID:</label><input type="text" id="getRestaurantId" required>
                    <button type="submit">Get</button>
                </form>
                <div id="getRestaurantResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>List Restaurants</h3>
                <button onclick="listRestaurants()">List All</button>
                <div id="listRestaurantsResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <div class="tab-content active" id="tab-menu">
            <div class="section">
                <h3>Menu Items</h3>
                <button onclick="fetchMenu()">Refresh Menu</button>
                <div id="menuList"></div>
            </div>
            <div class="section">
                <h4>Add Menu Item</h4>
                <form id="menuItemForm">
    <label>JWT (Admin):</label><input type="text" id="menuItemToken" required>
    <label>Restaurant ID:</label><input type="text" id="menuItemRestaurantId" required>
    <label>Name:</label><input type="text" id="itemName" required>
    <label>Description:</label><input type="text" id="itemDescription">
    <label>Price:</label><input type="number" step="0.01" id="itemPrice" required>
    <label>Available:</label><select id="itemAvailable"><option value="true">Yes</option><option value="false">No</option></select>
    <label>Category:</label><select id="itemCategory"></select>
    <button type="submit">Add</button>
</form>
                <div id="menuItemResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <div class="tab-content" id="tab-categories">
            <div class="section">
                <h3>Categories</h3>
                <div class="flex-row">
                    <input class="flex-grow" type="text" id="categoryRestaurantId" placeholder="Restaurant ID" required>
                    <button onclick="fetchCategories()">Refresh Categories</button>
                </div>
                <div id="categoryList"></div>
            </div>
            <div class="section">
                <h4>Add Category</h4>
                <form id="categoryForm">
    <label>JWT (Admin):</label><input type="text" id="categoryToken" required>
    <label>Restaurant ID:</label><input type="text" id="categoryRestaurantId" required>
    <label>Name:</label><input type="text" id="categoryName" required>
    <label>Description:</label><input type="text" id="categoryDescription">
    <button type="submit">Add</button>
</form>
                <div id="categoryResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <!-- LOYALTY TAB -->
        <div class="tab-content" id="tab-loyalty">
            <div class="section">
                <h3>Create Loyalty</h3>
                <form id="createLoyaltyForm">
    <label>JWT:</label><input type="text" id="loyaltyToken" required>
    <label>User UID:</label><input type="text" id="loyaltyUid" required>
    <label>Restaurant ID:</label><input type="text" id="loyaltyRestaurantId" required>
    <label>Total Points:</label><input type="number" id="loyaltyTotalPoints" value="0">
    <label>Restaurant Points:</label><input type="number" id="loyaltyRestaurantPoints" value="0">
    <label>Tier:</label><input type="text" id="loyaltyTier" value="Bronze">
    <label>Punches:</label><input type="number" id="loyaltyPunches" value="0">
    <label>Redemption History (JSON array):</label><textarea id="loyaltyRedemptionHistory" rows="1" placeholder="[]"></textarea>
    <label>Visited Restaurants (JSON array):</label><textarea id="loyaltyVisitedRestaurants" rows="1" placeholder="[]"></textarea>
    <label>Last Spin Time (ISO):</label><input type="text" id="loyaltyLastSpinTime" placeholder="YYYY-MM-DDTHH:MM:SS">
    <label>Spin History (JSON array):</label><textarea id="loyaltySpinHistory" rows="1" placeholder="[]"></textarea>
    <label>Referral Codes (JSON object):</label><textarea id="loyaltyReferralCodes" rows="1" placeholder="{}"></textarea>
    <label>Referrals Made (JSON array):</label><textarea id="loyaltyReferralsMade" rows="1" placeholder="[]"></textarea>
    <label>Referred By (JSON object):</label><textarea id="loyaltyReferredBy" rows="1" placeholder="{}"></textarea>
    <button type="submit">Create</button>
</form>
                <div id="createLoyaltyResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>List Loyalties</h3>
                <form id="listLoyaltiesForm">
                    <label>JWT:</label><input type="text" id="listLoyaltiesToken" required>
                    <label>User UID (optional):</label><input type="text" id="listLoyaltiesUid">
                    <button type="submit">List</button>
                </form>
                <div id="listLoyaltiesResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Get Loyalty</h3>
                <form id="getLoyaltyForm">
                    <label>JWT:</label><input type="text" id="getLoyaltyToken" required>
                    <label>User UID:</label><input type="text" id="getLoyaltyUid" required>
                    <label>Restaurant ID:</label><input type="text" id="getLoyaltyRestaurantId" required>
                    <button type="submit">Get</button>
                </form>
                <div id="getLoyaltyResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <!-- REFERRALS TAB -->
        <div class="tab-content" id="tab-referrals">
            <div class="section">
                <h3>Get Referral Code</h3>
                <form id="getReferralCodeForm">
                    <label>JWT:</label><input type="text" id="getReferralToken" required>
                    <label>User UID:</label><input type="text" id="getReferralUid" required>
                    <label>Restaurant ID:</label><input type="text" id="getReferralRestaurantId" required>
                    <button type="submit">Get Code</button>
                </form>
                <div id="getReferralCodeResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Apply Referral</h3>
                <form id="applyReferralForm">
    <label>JWT:</label><input type="text" id="applyReferralToken" required>
    <label>Referral Code:</label><input type="text" id="applyReferralCode" required>
    <label>Referred UID:</label><input type="text" id="applyReferralUid" required>
    <label>Restaurant ID:</label><input type="text" id="applyReferralRestaurantId" required>
    <label>Extra Data (JSON object, optional):</label><textarea id="applyReferralExtra" rows="1" placeholder='{"source": "web"}'></textarea>
    <button type="submit">Apply</button>
</form>
                <div id="applyReferralResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <!-- REWARDS TAB -->
        <div class="tab-content" id="tab-rewards">
            <div class="section">
                <h3>Claim Reward</h3>
                <form id="claimRewardForm">
    <label>JWT:</label><input type="text" id="claimRewardToken" required>
    <label>Restaurant ID:</label><input type="text" id="claimRewardRestaurantId" required>
    <label>Reward Name:</label><input type="text" id="claimRewardName" required>
    <label>Threshold ID (optional):</label><input type="number" id="claimRewardThresholdId">
    <label>WhatsApp Number (optional):</label><input type="text" id="claimRewardWhatsapp">
    <label>User Name (optional):</label><input type="text" id="claimRewardUserName">
    <button type="submit">Claim</button>
</form>
                <div id="claimRewardResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Validate Coupon</h3>
                <form id="validateCouponForm">
                    <label>JWT:</label><input type="text" id="validateCouponToken" required>
                    <label>Coupon Code:</label><input type="text" id="validateCouponCode" required>
                    <button type="submit">Validate</button>
                </form>
                <div id="validateCouponResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Redeem Coupon</h3>
                <form id="redeemCouponForm">
                    <label>JWT (Admin):</label><input type="text" id="redeemCouponToken" required>
                    <label>Coupon Code:</label><input type="text" id="redeemCouponCode" required>
                    <button type="submit">Redeem</button>
                </form>
                <div id="redeemCouponResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <!-- OTP TAB -->
        <div class="tab-content" id="tab-otp">
            <div class="section">
                <h3>Send OTP</h3>
                <form id="sendOtpForm">
                    <label>Phone Number:</label><input type="text" id="sendOtpNumber" required>
                    <button type="submit">Send OTP</button>
                </form>
                <div id="sendOtpResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Verify OTP</h3>
                <form id="verifyOtpForm">
                    <label>Phone Number:</label><input type="text" id="verifyOtpNumber" required>
                    <label>OTP:</label><input type="text" id="verifyOtpCode" required>
                    <button type="submit">Verify OTP</button>
                </form>
                <div id="verifyOtpResponse" class="response" style="display:none"></div>
            </div>
        </div>
        <!-- DASHBOARDS TAB -->
        <div class="tab-content" id="tab-dashboards">
            <div class="section">
                <h3>Admin Dashboard</h3>
                <form id="adminDashboardForm">
                    <label>Restaurant ID (optional):</label><input type="text" id="adminDashboardRestaurantId">
                    <button type="submit">Fetch</button>
                </form>
                <div id="adminDashboardResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>User Dashboard</h3>
                <form id="userDashboardForm">
                    <label>User UID:</label><input type="text" id="userDashboardUid" required>
                    <button type="submit">Fetch</button>
                </form>
                <div id="userDashboardResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>Place an Order</h3>
                <form id="orderForm">
    <label>User Token (JWT):</label>
    <input type="text" id="userToken" placeholder="Paste your JWT token here" required>
    <label>Restaurant ID:</label>
    <input type="text" id="orderRestaurantId" required>
    <label>Order Items (JSON):</label>
    <textarea id="orderItems" rows="3" placeholder='[{"item_id": 1, "quantity": 2}]'></textarea>
    <label>Promo Code (optional):</label>
    <input type="text" id="promoCode" placeholder="e.g. SPRINGSALE">
    <label>Submission (JSON, optional):</label>
    <textarea id="orderSubmission" rows="1" placeholder='{}'></textarea>
    <label>Claimed Reward (JSON, optional):</label>
    <textarea id="orderClaimedReward" rows="1" placeholder='{}'></textarea>
    <button type="submit">Place Order</button>
</form>
                <div id="orderResponse" class="response" style="display:none"></div>
            </div>
            <div class="section">
                <h3>My Orders</h3>
                <button onclick="fetchMyOrders()">Fetch My Orders</button>
            </div>
        </div>
        <div class="tab-content" id="tab-actions">
            <div class="section">
                <h3>Order Actions</h3>
                <form id="orderActionForm">
                    <label>User Token (JWT):</label>
                    <input type="text" id="actionUserToken" required>
                    <label>Order ID:</label>
                    <input type="number" id="actionOrderId" required>
                    <label>Action:</label>
                    <select id="orderAction">
                        <option value="cancel">Cancel</option>
                        <option value="confirm">Confirm (Admin)</option>
                        <option value="refund">Refund (Admin)</option>
                        <option value="audit">View Audit Log</option>
                        <option value="receipt">Download Receipt (PDF)</option>
                    </select>
                    <button type="submit">Execute Action</button>
                </form>
                <div id="orderActionResponse" class="response" style="display:none"></div>
            </div>
        </div>
    </div>
    <script>
        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            };
        });
        const API_BASE = 'http://localhost:8090/api/ordering';
        // --- Category CRUD ---            
        async function fetchCategories() {
            const restaurantId = document.getElementById('categoryRestaurantId').value.trim();
            if (!restaurantId) {
                alert('Please enter a Restaurant ID to fetch categories.');
                return;
            }
            const res = await fetch(API_BASE + '/menu/categories?restaurant_id=' + encodeURIComponent(restaurantId));
            const cats = await res.json();
            let html = '<table><tr><th>ID</th><th>Name</th><th>Actions</th></tr>';
            for (const c of cats) {
                html += `<tr><td>${c.id}</td><td>${c.name}</td><td><button class='inline-btn' onclick='deleteCategory(${c.id})'>Delete</button></td></tr>`;
            }
            html += '</table>';
            document.getElementById('categoryList').innerHTML = html;
            // Populate category dropdown in menu item form
            const sel = document.getElementById('itemCategory');
            sel.innerHTML = '';
            for (const c of cats) sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        }
        document.getElementById('categoryForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = document.getElementById('categoryToken').value.trim();
            const restaurant_id = document.getElementById('categoryRestaurantId').value.trim();
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const payload = { name, description };
            const res = await fetch(API_BASE + '/menu/categories?restaurant_id=' + encodeURIComponent(restaurant_id), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            showMsg('categoryResponse', res.ok ? 'Category added!' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchCategories();
        };
        async function deleteCategory(id) {
            const token = prompt('Admin JWT token for delete:');
            const res = await fetch(API_BASE + '/menu/categories/' + id, {
                method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            showMsg('categoryResponse', res.ok ? 'Category deleted!' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchCategories();
        }
        // --- Menu CRUD ---
        async function fetchMenu() {
            const restaurantId = document.getElementById('categoryRestaurantId').value.trim();
            if (!restaurantId) {
                alert('Please enter a Restaurant ID to fetch menu items.');
                return;
            }
            const res = await fetch(API_BASE + '/menu?restaurant_id=' + encodeURIComponent(restaurantId));
            const items = await res.json();
            let html = '<table><tr><th>ID</th><th>Name</th><th>Description</th><th>Price</th><th>Available</th><th>Category</th><th>Actions</th></tr>';
            for (const i of items) {
                html += `<tr><td>${i.id}</td><td>${i.name}</td><td>${i.description}</td><td>${i.price}</td><td>${i.available ? 'Yes' : 'No'}</td><td>${i.category ? i.category.name : ''}</td><td><button class='inline-btn' onclick='deleteMenuItem(${i.id})'>Delete</button></td></tr>`;
            }
            html += '</table>';
            document.getElementById('menuList').innerHTML = html;
        }
        document.getElementById('menuItemForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = document.getElementById('menuItemToken').value.trim();
            const restaurant_id = document.getElementById('menuItemRestaurantId').value.trim();
            const name = document.getElementById('itemName').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const price = parseFloat(document.getElementById('itemPrice').value);
            const available = document.getElementById('itemAvailable').value === 'true';
            const category_id = parseInt(document.getElementById('itemCategory').value);
            const payload = { restaurant_id, name, description, price, available, category_id };
            const res = await fetch(`${API_BASE}/menu/items?restaurant_id=${encodeURIComponent(restaurant_id)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + encodeURIComponent(token)
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            showMsg('menuItemResponse', res.ok ? 'Menu item added!' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchMenu();
        };
        async function deleteMenuItem(id) {
            const token = prompt('Admin JWT token for delete:');
            const res = await fetch(API_BASE + '/menu/items/' + id, {
                method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            showMsg('menuItemResponse', res.ok ? 'Menu item deleted!' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchMenu();
        }
        // --- Customer Order ---
        async function fetchMenuItems() {
            const restaurantId = document.getElementById('customerRestaurantId').value.trim();
            if (!restaurantId) {
                alert('Please enter a Restaurant ID to load menu.');
                return;
            }
            const res = await fetch(`${API_BASE}/menu?restaurant_id=${encodeURIComponent(restaurantId)}`);
            const items = await res.json();
            if (res.ok) {
                displayMenuItems(items);
            } else {
                alert('Error loading menu: ' + (items.detail || 'Unknown error'));
            }
        }

        function displayMenuItems(items) {
            let html = '<div class="menu-grid">';
            for (const item of items) {
                html += `
                    <div class="menu-item">
                        <h4>${item.name}</h4>
                        <p>${item.description || ''}</p>
                        <p>₹${item.price.toFixed(2)}</p>
                        <div>
                            <label>Qty:</label>
                            <input type="number" min="1" value="1" class="item-qty" data-item-id="${item.id}">
                            <button class="add-to-cart" onclick="addToCart(${item.id})">Add to Cart</button>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            document.getElementById('menuItemsList').innerHTML = html;
        }

        let cart = {};
        function addToCart(itemId) {
            const qtyInput = document.querySelector(`.item-qty[data-item-id="${itemId}"]`);
            const qty = parseInt(qtyInput.value) || 1;
            
            // Get item details
            const item = document.querySelector(`.menu-item[data-item-id="${itemId}"]`);
            const name = item.querySelector('h4').textContent;
            const price = parseFloat(item.querySelector('p:last-child').textContent.replace('₹', '').trim());
            
            // Add to cart
            if (!cart[itemId]) {
                cart[itemId] = { name, price, quantity: qty };
            } else {
                cart[itemId].quantity += qty;
            }
            updateCart();
        }

        function removeFromCart(itemId) {
            delete cart[itemId];
            updateCart();
        }

        function updateCart() {
            // Update cart display
            let html = '<table><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th><th>Actions</th></tr>';
            let total = 0;
            
            for (const [itemId, item] of Object.entries(cart)) {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td>${item.quantity}</td>
                        <td>₹${itemTotal.toFixed(2)}</td>
                        <td>
                            <button onclick="removeFromCart(${itemId})">Remove</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</table>';
            document.getElementById('cartItems').innerHTML = html;
            document.getElementById('cartTotal').textContent = total.toFixed(2);
        }

        document.getElementById('customerOrderForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = document.getElementById('userToken').value.trim();
            const restaurant_id = document.getElementById('customerRestaurantId').value.trim();
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('deliveryAddress').value.trim();
            const promo = document.getElementById('customerPromoCode').value.trim();
            
            // Prepare order items
            const items = [];
            for (const [itemId, item] of Object.entries(cart)) {
                items.push({ item_id: parseInt(itemId), quantity: item.quantity });
            }
            
            if (items.length === 0) {
                alert('Please add items to your cart before placing an order.');
                return;
            }
            
            const payload = {
                restaurant_id,
                items,
                promo_code: promo ? promo : undefined,
                submission: {
                    customer_name: name,
                    customer_phone: phone,
                    delivery_address: address
                }
            };
            
            const res = await fetch(API_BASE + '/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (res.ok) {
                alert('Order placed successfully! Order ID: ' + data.id);
                cart = {};
                updateCart();
                document.getElementById('customerOrderForm').reset();
            } else {
                alert('Error placing order: ' + (data.detail || 'Unknown error'));
            }
        };

        async function fetchMyOrders() {
            const token = document.getElementById('userToken').value.trim();
            if (!token) { alert('User token required.'); return; }
            const res = await fetch(API_BASE + '/orders/history', { headers: { 'Authorization': 'Bearer ' + token } });
            const orders = await res.json();
            if (res.ok && Array.isArray(orders)) {
                let html = '<table><tr><th>ID</th><th>Status</th><th>Total</th><th>Created</th><th>Payment</th><th>Actions</th></tr>';
                for (const o of orders) {
                    html += `<tr>
                        <td>${o.id}</td>
                        <td>${o.status}</td>
                        <td>${o.total_cost}</td>
                        <td>${o.created_at}</td>
                        <td>${o.payment_status}</td>
                        <td>
                            ${o.status === 'Pending' ? '<button class="inline-btn" onclick="cancelOrder(${o.id})">Cancel</button>' : ''}
                            ${o.status === 'Preparing' ? '<button class="inline-btn" onclick="markOrderPaid(${o.id})">Mark Paid</button>' : ''}
                        </td>
                    </tr>`;
                }
                html += '</table>';
                document.getElementById('myOrders').innerHTML = html;
            } else {
                document.getElementById('myOrders').innerHTML = '<div class="error">' + (orders.detail || 'Error fetching orders') + '</div>';
            }
        }

        // Admin Order Management
        let adminPoolingInterval;
        async function startAdminPooling() {
            const token = document.getElementById('adminToken').value.trim();
            if (!token) { alert('Admin token required.'); return; }
            
            // First fetch initial orders
            await fetchAdminOrders();
            
            // Then start pooling
            adminPoolingInterval = setInterval(fetchAdminOrders, 5000); // Pool every 5 seconds
            document.getElementById('adminPoolingStatus').textContent = 'Pooling active (every 5s)';
            document.getElementById('adminPoolingStatus').style.color = 'green';
        }

        async function stopAdminPooling() {
            if (adminPoolingInterval) {
                clearInterval(adminPoolingInterval);
                document.getElementById('adminPoolingStatus').textContent = 'Pooling stopped';
                document.getElementById('adminPoolingStatus').style.color = 'red';
            }
        }

        async function fetchAdminOrders() {
            const token = document.getElementById('adminToken').value.trim();
            const res = await fetch(API_BASE + '/orders', { headers: { 'Authorization': 'Bearer ' + token } });
            const orders = await res.json();
            if (res.ok && Array.isArray(orders)) {
                let html = '<table><tr><th>ID</th><th>User</th><th>Status</th><th>Total</th><th>Created</th><th>Payment</th><th>Actions</th></tr>';
                for (const o of orders) {
                    html += `<tr>
                        <td>${o.id}</td>
                        <td>${o.user_id}</td>
                        <td>${o.status}</td>
                        <td>${o.total_cost}</td>
                        <td>${o.created_at}</td>
                        <td>${o.payment_status}</td>
                        <td>
                            <button class="inline-btn" onclick="updateOrderStatus(${o.id}, 'Preparing')">Preparing</button>
                            <button class="inline-btn" onclick="updateOrderStatus(${o.id}, 'Done')">Done</button>
                            <button class="inline-btn" onclick="updateOrderStatus(${o.id}, 'Completed')">Completed</button>
                            <button class="inline-btn" onclick="updateOrderStatus(${o.id}, 'Cancelled')">Cancel</button>
                            <button class="inline-btn" onclick="markOrderPaid(${o.id})">Mark Paid</button>
                            <button class="inline-btn" onclick="refundOrder(${o.id})">Refund</button>
                        </td>
                    </tr>`;
                }
                html += '</table>';
                document.getElementById('adminOrders').innerHTML = html;
            } else {
                document.getElementById('adminOrders').innerHTML = '<div class="error">' + (orders.detail || 'Error fetching admin orders') + '</div>';
            }
        }

        // Order Actions
        document.getElementById('orderActionForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = document.getElementById('actionUserToken').value.trim();
            const orderId = document.getElementById('actionOrderId').value.trim();
            const action = document.getElementById('orderAction').value;
            const res = await fetch(`${API_BASE}/orders/${orderId}/action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ action })
            });
            const data = await res.json();
            showMsg('orderActionResponse', res.ok ? 'Action performed successfully' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchAdminOrders(); // Refresh admin orders if action was performed
        };

        // Order Filter
        document.getElementById('orderFilterForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = document.getElementById('filterToken').value.trim();
            const status = document.getElementById('filterStatus').value;
            const paymentMethod = document.getElementById('filterPaymentMethod').value;
            const userId = document.getElementById('filterUserId').value.trim();
            
            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (paymentMethod) params.append('payment_method', paymentMethod);
            if (userId) params.append('user_id', userId);
            
            const res = await fetch(`${API_BASE}/orders/filter?${params.toString()}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const orders = await res.json();
            if (res.ok && Array.isArray(orders)) {
                let html = '<table><tr><th>ID</th><th>User</th><th>Status</th><th>Total</th><th>Created</th><th>Payment</th></tr>';
                for (const o of orders) {
                    html += `<tr>
                        <td>${o.id}</td>
                        <td>${o.user_id}</td>
                        <td>${o.status}</td>
                        <td>${o.total_cost}</td>
                        <td>${o.created_at}</td>
                        <td>${o.payment_status}</td>
                    </tr>`;
                }
                html += '</table>';
                document.getElementById('filteredOrders').innerHTML = html;
            } else {
                document.getElementById('filteredOrders').innerHTML = '<div class="error">' + (orders.detail || 'Error filtering orders') + '</div>';
            }
        };

        // Individual Order Actions
        async function updateOrderStatus(orderId, status) {
            const token = document.getElementById('adminToken').value.trim();
            const res = await fetch(`${API_BASE}/orders/${orderId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ status })
            });
            const data = await res.json();
            showMsg('orderActionResponse', res.ok ? 'Status updated' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchAdminOrders();
        }

        async function markOrderPaid(orderId) {
            const token = document.getElementById('adminToken').value.trim();
            const res = await fetch(`${API_BASE}/orders/${orderId}/payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            showMsg('orderActionResponse', res.ok ? 'Marked as paid' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchAdminOrders();
        }

        async function refundOrder(orderId) {
            const token = document.getElementById('adminToken').value.trim();
            const res = await fetch(`${API_BASE}/orders/${orderId}/refund`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            showMsg('orderActionResponse', res.ok ? 'Refunded successfully' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchAdminOrders();
        }

        async function cancelOrder(orderId) {
            const token = document.getElementById('userToken').value.trim();
            const res = await fetch(`${API_BASE}/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            showMsg('orderResponse', res.ok ? 'Order cancelled' : 'Error: ' + (data.detail || JSON.stringify(data)), !res.ok);
            fetchMyOrders();
        }
        // --- Order Actions ---
        document.getElementById('orderActionForm').onsubmit = async function(e) {
            e.preventDefault();
            const orderId = document.getElementById('actionOrderId').value;
            const action = document.getElementById('orderAction').value;
            const token = document.getElementById('actionUserToken').value.trim();
            if (!token) { showMsg('orderActionResponse', 'User token required.', true); return; }
            let url = API_BASE + '/order/' + orderId;
            let opts = { headers: { 'Authorization': 'Bearer ' + token } };
            if (action === 'cancel') { url += '/cancel'; opts.method = 'POST'; }
            else if (action === 'confirm') { url += '/confirm'; opts.method = 'POST'; }
            else if (action === 'refund') { url += '/refund'; opts.method = 'POST'; }
            else if (action === 'audit') { url += '/audit'; }
            else if (action === 'receipt') { window.open(url + '/receipt?token=' + encodeURIComponent(token), '_blank'); showMsg('orderActionResponse', 'Receipt will download in a new tab.'); return; }
            fetch(url, opts)
                .then(r => r.json().then(data => ({ ok: r.ok, data })))
                .then(res => {
                    if (res.ok) showMsg('orderActionResponse', 'Success: ' + JSON.stringify(res.data));
                    else showMsg('orderActionResponse', 'Error: ' + (res.data.detail || JSON.stringify(res.data)), true);
                })
                .catch(err => showMsg('orderActionResponse', 'Network error: ' + err, true));
        };
        // --- Helper ---
        function showMsg(id, msg, isErr) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.style.display = 'block';
            el.className = 'response' + (isErr ? ' error' : '');
        }
        // Initial fetch
        fetchCategories();
        fetchMenu();
    </script>
</body>
</html>
